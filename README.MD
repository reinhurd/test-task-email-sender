# Тестовое задание по уведомлениям о рассылках

**Важно**: Само задание не публикуется по причине публичности данного репозитория.

## Проблема

До миллиона записей необходимо обработать в течение одного дня (1440 минут). При этом методы валидации и отправки сообщений очень затратны по времени, и один PHP-процесс (если делать все в нем) может отрабатывать до 1 миллиона минут в худшем случае.

## Решение

Для решения тестового задания был выбран примитивный подход через cron:

1. Для проверки валидности почт и отправки сообщений используются отдельные кроны.
2. По каждому из кронов каждые 10 минут стартует 1000 процессов, которые выбирают по 10 записей из соответствующих таблиц.
3. При самом плохом сценарии (миллион почт, которых нужно проверить и отправить сегодня) - за сутки мы обработаем 144 * 10000 = 1440000 записей, что вполне укладывается.
4. Защита от повторного запроса по уже проверенным почтам осуществляется через проверку на наличие почты юзера в таблице emails (мы не пишем туда адреса, которые были не проверены).
5. Защита от повторной отправки сообщений осуществляется через дополнительное поле `expiration_notice` в таблице emails.

### Минусы подхода

- Большое количество подключений к базе (до 2000 в моменте при худших вариантах).
- Большое количество PHP-процессов (до 2000 в моменте при худших вариантах).

### Альтернативы

- Использование Swoole/Parallels (для имитации многопоточности в рамках одного процесса в PHP).
- Использование RabbitMQ для более корректной реализации очередей.

## Общий алгоритм решения

1. Получаем перечень почт, по которым есть отметка `confirmed`, срок истечения подписки меньше трех дней, и которые ранее не были провалидированы.
2. Проверяем их на валидность и записываем результаты в таблицу emails.
3. Проверяем срок истечения подписки и отправляем уведомления пользователям с валидными почтами, если ранее такие уведомления не отправлялись (сценарий продления даты подписки для старого пользователя не предусмотрен, только появление новых пользователей)

## Запуск сервиса локально

1. Запустите сервис с помощью Docker Compose: `docker-compose up -d` (если нужно пересобрать: `docker-compose down && docker-compose build && docker-compose up -d`).
2. Логи крона, а также перечень почт, на которые была отправка, складываются в папку `logs`
3. Если нужно проверить быстрые сценарии, нужно уменьшить количество создаваемых тестовых данных в миграции и количество процессов в crontab
4. Один из контейнеров - phpmyadmin, доступен по адресу http://localhost:8080, для быстрых проверок данных через интерфейс
